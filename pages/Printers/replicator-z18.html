<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Standard Printer Checkout - 3D Printing Services</title>
    <link href="/assets/styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body data-bs-theme="dark">

<!-- Nav Bar -->
<nav style="background-color: #e3f2fd;" data-bs-theme="light">
    <ul class="nav navbar justify-content-center nav-pills nav-fill" style="margin-left: 5%;">
        <li class="nav-item">
            <a class="nav-link" style="color:black;" href="/index.html">Home</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" style="color:black;" href="/pages/store.html">Store</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active bg-dark" aria-current="page" href="#">Checkout</a>
        </li>
    </ul>
</nav>

<div class="container mt-4">
    <div class="row">
        <!-- Left Column - Printer Info and Status -->
        <div class="col-md-4">
            <div class="card bg-dark text-light mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Printer Status</h4>
                    <span class="badge bg-success">Available</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Industrial FDM Printer Specifications</h5>
                    <ul class="list-unstyled">
                        <li><strong>Model:</strong> MakerBot Replicator Z18</li>
                        <li><strong>Build Volume:</strong> 305 x 305 x 457mm (12.0 x 12.0 x 18.0 in)</li>
                        <li><strong>Materials:</strong> 
                            <ul>
                                <li>MakerBot PLA (Standard)</li>
                                <li>ABS (Engineering Grade)</li>
                                <li>TOUGH PLA (Engineering Grade)</li>
                            </ul>
                        </li>
                        <li><strong>Key Features:</strong>
                            <ul>
                                <li>Industrial-grade reliability</li>
                                <li>Heated, enclosed build chamber</li>
                                <li>Built-in camera monitoring</li>
                                <li>Network connectivity (Wi-Fi, Ethernet)</li>
                            </ul>
                        </li>
                        <li><strong>Software:</strong> MakerBot Print</li>
                        <li><strong>Print Characteristics:</strong> Reliable, consistent quality with focus on precision over speed</li>
                    </ul>
                    <hr>
                    <h5>Current Queue</h5>
                    <p class="text-muted">No prints in queue</p>
                </div>
            </div>
        </div>

        <!-- Center Column - Live Feed -->
        <div class="col-md-4">
            <div class="card bg-dark text-light mb-4">
                <div class="card-header">
                    <h4>Live Printer Feed</h4>
                </div>
                <div class="card-body p-0">
                    <div class="ratio ratio-1x1">
                        <!-- Replace this div with actual stream when implemented -->
                        <div class="bg-secondary d-flex align-items-center justify-content-center">
                            
            <iframe class="w-100 h-100" 
                    src="https://www.youtube.com/embed/wpBOrDXIWww?si=1Zm_CJtC18xERJvo&autoplay=1&mute=1" 
                    title="YouTube video player" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen>
            </iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - File Upload and Checkout -->
        <div class="col-md-4">
            <div class="card bg-dark text-light mb-4">
                <div class="card-header">
                    <h4>Upload Your File</h4>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label for="fileUpload" class="form-label">3D Model File (STL, OBJ)</label>
                            <input class="form-control" type="file" id="fileUpload" accept=".stl,.obj">
                            <div class="form-text">Maximum file size: 50MB</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="service-tier" class="form-label">Service Tier</label>
                            <select class="form-select" id="service-tier">
                                <option value="standard">Standard Quality (0.2mm)
                                    <br>• $10/hour + $0.20/gram
                                    <br>• Basic resolution
                                    <br>• No post-processing
                                </option>
                                <option value="highq">High Quality (0.1mm)
                                    <br>• $15/hour + $0.40/gram
                                    <br>• Smoother surface finish
                                    <br>• Light sanding included
                                </option>
                                <option value="engineering">Engineering Grade
                                    <br>• $20/hour + $0.75/gram
                                    <br>• ABS or TOUGH PLA
                                    <br>• Annealing available
                                    <br>• Full post-processing
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="material" class="form-label">Material Selection</label>
                            <select class="form-select" id="material">
                                <option value="pla" data-tier="standard,highq">MakerBot PLA - Standard</option>
                                <option value="abs" data-tier="engineering">ABS - Engineering Grade</option>
                                <option value="toughpla" data-tier="engineering">TOUGH PLA - Engineering Grade</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="post-processing" class="form-label">Post-Processing Options</label>
                            <select class="form-select" id="post-processing" multiple>
                                <option value="sanding">Light Sanding (Included with High-Q)</option>
                                <option value="annealing">Annealing (Engineering Grade Only)</option>
                                <option value="acetone">Acetone Smoothing (ABS Only)</option>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple options</div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Special Instructions</label>
                            <textarea class="form-control" id="notes" rows="3" placeholder="Include any specific requirements for your print (e.g., specific tolerances, end-use requirements)"></textarea>
                        </div>

                        <div class="alert alert-info">
                            <small>
                                <strong>Pricing Structure:</strong><br>
                                • Base rate depends on service tier selected<br>
                                • Material costs calculated by weight<br>
                                • Final quote provided after file analysis<br>
                                • Engineering grade includes additional quality assurance
                            </small>
                        </div>

                        <div class="mb-3">
                            <button id="authButton" type="button" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Connect to Google Drive
                            </button>
                            <button id="uploadButton" type="button" class="btn btn-outline-success w-100" disabled>
                                Upload Files
                            </button>
                            <div id="uploadStatus" class="alert mt-2" style="display: none;"></div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="mt-5">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://kit.fontawesome.com/your-font-awesome-kit.js" crossorigin="anonymous"></script>
    <script>
        // Replace these with your actual credentials
        const CLIENT_ID = '171594389462-eheec7j2b6nsus2vpjbv42g690nlo5gk.apps.googleusercontent.com';
        const API_KEY = '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';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Initialize the API
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // Initialize Google Identity Services
        function gisInit() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        // Enable buttons if API is ready
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authButton').disabled = false;
            }
        }

        // Handle authorization
        function handleAuthClick() {
            const button = document.getElementById('authButton');
            const uploadButton = document.getElementById('uploadButton');
            const statusDiv = document.getElementById('uploadStatus');

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw resp;
                }
                button.innerHTML = '<i class="fas fa-check me-2"></i>Connected to Google Drive';
                button.classList.replace('btn-outline-primary', 'btn-success');
                uploadButton.disabled = false;
                statusDiv.style.display = 'none';
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Handle file upload
        async function handleUploadClick() {
            const fileInput = document.getElementById('fileUpload');
            const statusDiv = document.getElementById('uploadStatus');
            const uploadButton = document.getElementById('uploadButton');

            if (!fileInput.files.length) {
                showStatus('Please select a file first.', 'warning');
                return;
            }

            try {
                uploadButton.disabled = true;
                showStatus('Uploading file...', 'info');

                const file = fileInput.files[0];
                const metadata = {
                    name: file.name,
                    mimeType: file.type,
                };

                // Create a new folder for 3D print files if it doesn't exist
                const folderMetadata = {
                    name: '3D Print Files',
                    mimeType: 'application/vnd.google-apps.folder'
                };

                let folder = await gapi.client.drive.files.list({
                    q: "name='3D Print Files' and mimeType='application/vnd.google-apps.folder'",
                    fields: 'files(id)'
                });

                let folderId;
                if (folder.result.files.length === 0) {
                    const folderResponse = await gapi.client.drive.files.create({
                        resource: folderMetadata,
                        fields: 'id'
                    });
                    folderId = folderResponse.result.id;
                } else {
                    folderId = folder.result.files[0].id;
                }

                metadata.parents = [folderId];

                // Upload the file
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                form.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
                    body: form
                });

                const result = await response.json();
                showStatus('File uploaded successfully!', 'success');
            } catch (err) {
                showStatus('Error uploading file: ' + err.message, 'danger');
                console.error('Error:', err);
            } finally {
                uploadButton.disabled = false;
            }
        }

        // Helper function to show status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = `alert alert-${type} mt-2`;
            statusDiv.textContent = message;
        }

        // Add event listeners
        document.getElementById('authButton').onclick = handleAuthClick;
        document.getElementById('uploadButton').onclick = handleUploadClick;

        // Load the API
        gapi.load('client', initializeGapiClient);
        gisInit();
    </script>
</footer>

</body>
</html>
